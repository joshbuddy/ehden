module Ehden
  class Map
    abstract class Tile
      abstract def sprite : SF::Sprite

      TILESET = SF::Texture.from_file("./src/ehden/tiles/tiles.png")
    end

    class Grass < Tile
      getter sprite

      @sprite = SF::Sprite.new(TILESET, SF.int_rect(80, 80, 16, 16))
    end

    class GrassTop < Tile
      getter sprite

      @sprite = SF::Sprite.new(TILESET, SF.int_rect(32, 32, 16, 16))
    end

    class GrassTopLeft < Tile
      getter sprite

      @sprite = SF::Sprite.new(TILESET, SF.int_rect(16, 32, 16, 16))
    end

    class GrassTopRight < Tile
      getter sprite

      @sprite = SF::Sprite.new(TILESET, SF.int_rect(96, 32, 16, 16))
    end

    @tile_size = 32
    @tiles = [] of Tile
    @width = 52
    @height = 35
    @position = {0, 0}
    @render_width = 25
    @render_height = 25

    def initialize
      @tiles = [] of Tile
      tile_map = {
        '0' => Grass.new,
        '1' => GrassTopLeft.new,
        '2' => GrassTop.new,
        '3' => GrassTopRight.new,
      }

      raw_map = <<-EOT
      1222222222222222222222223222222222222222222222222223
      0000000000000000000000000000000000000000000000000000
      0000000000000000000000000000000000000000000000000000
      0000000000000000000000000000000000000000000000000000
      0000000000000000000000000000000000000000000000000000
      0000000000000000000000000000000000000000000000000000
      0000000000000000000000000000000000000000000000000000
      0000000000000000000000000000000000000000000000000000
      0000000000000000000000000000000000000000000000000000
      0000000000000000000000000000000000000000000000000000
      0000000000000000000000000000000000000000000000000000
      0000000000000000000000000000000000000000000000000000
      0000000000000000000000000000000000000000000000000000
      0000000000000000000000000000000000000000000000000000
      0000000000000000000000000000000000000000000000000000
      0000000000000000000000000000000000000000000000000000
      0000000000000000000000000000000000000000000000000000
      0000000000000000000000000000000000000000000000000000
      0000000000000000000000000000000000000000000000000000
      0000000000000000000000000000000000000000000000000000
      0000000000000000000000000000000000000000000000000000
      0000000000000000000000000000000000000000000000000000
      0000000000000000000000000000000000000000000000000000
      0000000000000000000000000000000000000000000000000000
      0000000000000000000000000000000000000000000000000000
      0000000000000000000000000000000000000000000000000000
      0000000000000000000000000000000000000000000000000000
      0000000000000000000000000000000000000000000000000000
      0000000000000000000000000000000000000000000000000000
      0000000000000000000000000000000000000000000000000000
      0000000000000000000000000000000000000000000000000000
      0000000000000000000000000000000000000000000000000000
      0000000000000000000000000000000000000000000000000000
      0000000000000000000000000000000000000000000000000000
      EOT

      lines = raw_map.lines.map do |char_line|
        char_line.chomp.each_char do |c|
          @tiles << tile_map.fetch(c)
        end
      end
    end

    def render(window)
      (@position[0]..@render_width + @position[0]).each do |x|
        (@position[1]..@render_height + @position[1]).each do |y|
          tile = @tiles[x + y * @width]
          tile.sprite.position = {x * @tile_size, y * @tile_size}
          tile.sprite.scale = {2, 2}
          window.draw tile.sprite
        end
      end
    end
  end
end
